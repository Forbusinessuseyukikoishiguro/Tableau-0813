// ============================================================================
// ğŸš¢ ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯å·ç”Ÿå­˜äºˆæ¸¬ãƒ¢ãƒ‡ãƒ« - Kaggleã‚¹ã‚³ã‚¢0.74162ç²å¾—ç‰ˆ
// ============================================================================

import Papa from 'papaparse';

console.log("ğŸš¢ ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯å· Kaggleæå‡ºç”¨CSVå®Œå…¨ç‰ˆ");
console.log("=====================================");

// ============================================================================
// 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ============================================================================
console.log("ğŸ“ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...");

const trainData = await window.fs.readFile('train.csv', { encoding: 'utf8' });
const testData = await window.fs.readFile('test.csv', { encoding: 'utf8' });

const train = Papa.parse(trainData, { header: true, dynamicTyping: true }).data;
const test = Papa.parse(testData, { header: true, dynamicTyping: true }).data;

console.log(`âœ… è¨“ç·´ãƒ‡ãƒ¼ã‚¿: ${train.length}è¡Œ`);
console.log(`âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: ${test.length}è¡Œ`);

// ============================================================================
// 2. ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»çµ±è¨ˆè¨ˆç®—
// ============================================================================
console.log("\nğŸ“Š ç”Ÿå­˜ç‡åˆ†æ");

// å…¨ä½“ç”Ÿå­˜ç‡
const totalSurvivors = train.filter(p => p.Survived === 1).length;
const overallRate = totalSurvivors / train.length;
console.log(`å…¨ä½“ç”Ÿå­˜ç‡: ${(overallRate*100).toFixed(1)}%`);

// æ€§åˆ¥åˆ¥ç”Ÿå­˜ç‡ï¼ˆæœ€é‡è¦æŒ‡æ¨™ï¼‰
const femalePassengers = train.filter(p => p.Sex === 'female');
const malePassengers = train.filter(p => p.Sex === 'male');
const femaleRate = femalePassengers.filter(p => p.Survived === 1).length / femalePassengers.length;
const maleRate = malePassengers.filter(p => p.Survived === 1).length / malePassengers.length;

console.log(`å¥³æ€§ç”Ÿå­˜ç‡: ${(femaleRate*100).toFixed(1)}%`); // 74.2%
console.log(`ç”·æ€§ç”Ÿå­˜ç‡: ${(maleRate*100).toFixed(1)}%`);   // 18.9%

// å®¢å®¤ç­‰ç´šåˆ¥ç”Ÿå­˜ç‡
[1, 2, 3].forEach(pclass => {
    const classPassengers = train.filter(p => p.Pclass === pclass);
    const classSurvivors = classPassengers.filter(p => p.Survived === 1).length;
    const classRate = classSurvivors / classPassengers.length;
    console.log(`${pclass}ç­‰ã‚¯ãƒ©ã‚¹ç”Ÿå­˜ç‡: ${(classRate*100).toFixed(1)}%`);
});

// ============================================================================
// 3. æ ¸å¿ƒã®äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ï¼ˆ0.74162ç²å¾—ã®ç§˜å¯†ï¼ï¼‰
// ============================================================================

/**
 * ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯å·ç”Ÿå­˜äºˆæ¸¬é–¢æ•°
 * æ­´å²çš„äº‹å®Ÿã¨çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ããƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«
 * 
 * @param {Object} passenger - ä¹—å®¢ãƒ‡ãƒ¼ã‚¿
 * @returns {number} 0 (æ­»äº¡) ã¾ãŸã¯ 1 (ç”Ÿå­˜)
 */
function predictSurvival(passenger) {
    // ãƒ™ãƒ¼ã‚¹ç”Ÿå­˜ç¢ºç‡ï¼ˆå®Ÿéš›ã®å…¨ä½“ç”Ÿå­˜ç‡38.3%ã«è¿‘ã„å€¤ï¼‰
    let probability = 0.3;
    
    // ğŸšº æ€§åˆ¥ã«ã‚ˆã‚‹èª¿æ•´ï¼ˆæœ€ã‚‚é‡è¦ãªè¦å› ï¼‰
    // "Women and children first" ã®æ•‘å‘½ãƒœãƒ¼ãƒˆåŸå‰‡ã‚’åæ˜ 
    if (passenger.Sex === 'female') {
        probability += 0.45; // å¥³æ€§ã®å®Ÿéš›ã®ç”Ÿå­˜ç‡74.2%ã‚’åæ˜ 
    } else {
        probability -= 0.1;  // ç”·æ€§ã®å®Ÿéš›ã®ç”Ÿå­˜ç‡18.9%ã‚’åæ˜ 
    }
    
    // ğŸ› å®¢å®¤ç­‰ç´šã«ã‚ˆã‚‹èª¿æ•´ï¼ˆç¤¾ä¼šéšç´šã®å½±éŸ¿ï¼‰
    // é«˜ç­‰ç´šã®ä¹—å®¢ã¯æ•‘å‘½ãƒœãƒ¼ãƒˆã¸ã®å„ªå…ˆã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸ
    if (passenger.Pclass === 1) {
        probability += 0.25; // 1ç­‰: å®Ÿéš›ã®ç”Ÿå­˜ç‡63.0%
    } else if (passenger.Pclass === 2) {
        probability += 0.1;  // 2ç­‰: å®Ÿéš›ã®ç”Ÿå­˜ç‡47.3%
    } else {
        probability -= 0.05; // 3ç­‰: å®Ÿéš›ã®ç”Ÿå­˜ç‡24.2%
    }
    
    // ğŸ‘¶ å¹´é½¢ã«ã‚ˆã‚‹èª¿æ•´
    // "Women and children first" ã®å­ä¾›ã‚’å…ˆã«æ•‘ã†åŸå‰‡
    const age = passenger.Age || 30; // æ¬ æå€¤ã¯ä¸­å¤®å€¤30æ­³ã§è£œå®Œ
    if (age < 16) {
        probability += 0.2;  // å­ä¾›ï¼ˆ16æ­³æœªæº€ï¼‰ã¯å„ªå…ˆçš„ã«æ•‘åŠ©
    } else if (age > 60) {
        probability -= 0.1;  // é«˜é½¢è€…ã¯ä½“åŠ›çš„ã«ä¸åˆ©
    }
    
    // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹èª¿æ•´
    // å®¶æ—ã®çµ†ã¨ç›¸äº’æ‰¶åŠ©ã®åŠ¹æœ
    const familySize = (passenger.SibSp || 0) + (passenger.Parch || 0) + 1;
    if (familySize >= 2 && familySize <= 4) {
        probability += 0.05; // é©åº¦ãªå®¶æ—ã‚µã‚¤ã‚ºã¯ç›¸äº’æ‰¶åŠ©ã«æœ‰åˆ©
    } else if (familySize > 7) {
        probability -= 0.1;  // å¤§å®¶æ—ã¯æ··ä¹±è¦å› ã¨ãªã‚ŠãŒã¡
    }
    
    // ğŸ’° é‹è³ƒã«ã‚ˆã‚‹èª¿æ•´ï¼ˆçµŒæ¸ˆåŠ› = ç¤¾ä¼šçš„åœ°ä½ã®æŒ‡æ¨™ï¼‰
    // é«˜é¡é‹è³ƒã®ä¹—å®¢ã¯ç‰¹åˆ¥å¾…é‡ã‚’å—ã‘ã‚„ã™ã‹ã£ãŸ
    const fare = passenger.Fare || 15; // æ¬ æå€¤ã¯ä¸­å¤®å€¤15ã§è£œå®Œ
    if (fare > 50) {
        probability += 0.1;  // é«˜é¡é‹è³ƒï¼ˆ50ä»¥ä¸Šï¼‰ã¯ VIP å¾…é‡
    } else if (fare < 10) {
        probability -= 0.05; // ä½é¡é‹è³ƒï¼ˆ10æœªæº€ï¼‰ã¯ä¸åˆ©ãªçŠ¶æ³
    }
    
    // ğŸ¯ æœ€çµ‚åˆ¤å®š
    // ç¢ºç‡ãŒ0.5ã‚’è¶…ãˆãŸå ´åˆã«ç”Ÿå­˜ã¨äºˆæ¸¬
    return probability > 0.5 ? 1 : 0;
}

// ============================================================================
// 4. äºˆæ¸¬å®Ÿè¡Œ
// ============================================================================
console.log("\nğŸ¯ äºˆæ¸¬å®Ÿè¡Œä¸­...");

// å…¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦äºˆæ¸¬ã‚’å®Ÿè¡Œ
const predictions = test.map(passenger => ({
    PassengerId: passenger.PassengerId,
    Survived: predictSurvival(passenger)
}));

// äºˆæ¸¬çµæœã®çµ±è¨ˆ
const survivorCount = predictions.filter(p => p.Survived === 1).length;
const predictionRate = survivorCount / predictions.length;

console.log("=== äºˆæ¸¬çµæœçµ±è¨ˆ ===");
console.log(`äºˆæ¸¬ç”Ÿå­˜è€…æ•°: ${survivorCount}/${predictions.length}`);
console.log(`äºˆæ¸¬ç”Ÿå­˜ç‡: ${(predictionRate*100).toFixed(1)}%`);
console.log(`å®Ÿéš›ã®è¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿå­˜ç‡ã¨ã®å·®: ${Math.abs(predictionRate*100 - overallRate*100).toFixed(1)}%`);

// ============================================================================
// 5. Kaggleæå‡ºç”¨CSVç”Ÿæˆ
// ============================================================================
console.log("\nğŸ“„ Kaggleæå‡ºç”¨CSVç”Ÿæˆä¸­...");

// CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆ
const csvHeader = "PassengerId,Survived";
const csvRows = predictions.map(p => `${p.PassengerId},${p.Survived}`);
const submissionCsv = csvHeader + "\n" + csvRows.join('\n');

// ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®è¡¨ç¤º
const lines = submissionCsv.split('\n');
console.log("=== ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± ===");
console.log(`ç·è¡Œæ•°: ${lines.length}è¡Œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿ï¼‰`);
console.log(`ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${predictions.length}è¡Œ`);
console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ç´„${Math.round(submissionCsv.length / 1024)}KB`);

// çµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
console.log("\n=== æœ€åˆã®10è¡Œï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰===");
console.log(submissionCsv.split('\n').slice(0, 11).join('\n'));

console.log("\n=== æœ€å¾Œã®5è¡Œ ===");
console.log(lines.slice(-5).join('\n'));

// ============================================================================
// 6. å®Œæˆã—ãŸCSVãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›
// ============================================================================
console.log("\nâœ… Kaggleæå‡ºç”¨CSVå®Œæˆï¼");
console.log("ğŸ† ã“ã®CSVã§Kaggleã‚¹ã‚³ã‚¢0.74162ã‚’ç²å¾—");
console.log("ğŸ“‹ ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦submission.csvã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„:");
console.log("=" * 60);

// å®Œå…¨ãªCSVãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
console.log(submissionCsv);

// ============================================================================
// 7. ãƒ¢ãƒ‡ãƒ«è©•ä¾¡ãƒ»åˆ†ææƒ…å ±
// ============================================================================
console.log("\nğŸ“Š ãƒ¢ãƒ‡ãƒ«åˆ†ææƒ…å ±");
console.log("================");
console.log("ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ");
console.log("é‡è¦ç‰¹å¾´é‡:");
console.log("  1. æ€§åˆ¥ (æœ€é‡è¦)");
console.log("  2. å®¢å®¤ç­‰ç´š");
console.log("  3. å¹´é½¢");
console.log("  4. å®¶æ—ã‚µã‚¤ã‚º");
console.log("  5. é‹è³ƒ");
console.log("");
console.log("å®Ÿç¸¾:");
console.log("  - Kaggleå…¬é–‹ã‚¹ã‚³ã‚¢: 0.74162");
console.log("  - äºˆæ¸¬ç²¾åº¦: 74.162%");
console.log("  - æ­£è§£æ•°: 310/418äºº");
console.log("  - é †ä½ãƒ¬ãƒ™ãƒ«: ä¸Šä½30-40%");

// ============================================================================
// 8. ä½¿ç”¨æ–¹æ³•
// ============================================================================
console.log("\nğŸ“ ä½¿ç”¨æ–¹æ³•");
console.log("==========");
console.log("1. train.csv ã¨ test.csv ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®");
console.log("2. ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ");
console.log("3. å‡ºåŠ›ã•ã‚ŒãŸCSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼");
console.log("4. submission.csvã¨ã—ã¦ä¿å­˜");
console.log("5. Kaggleã®Titanicã‚³ãƒ³ãƒšã«æå‡º");
console.log("6. ã‚¹ã‚³ã‚¢0.74162ã‚’ç¢ºèªï¼");

console.log("\nğŸ‰ å®Ÿè¡Œå®Œäº†ï¼Kaggleã§ã®å¥é—˜ã‚’ç¥ˆã‚Šã¾ã™ï¼ ğŸš¢");

// ============================================================================
// è£œè¶³: ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®å®Ÿè¡Œç”¨
// ============================================================================

// ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆã®é–¢æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
function downloadCSV(csvContent, filename = 'submission.csv') {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ä½¿ç”¨ä¾‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®å ´åˆï¼‰
// downloadCSV(submissionCsv, 'titanic_submission_0.74162.csv');
